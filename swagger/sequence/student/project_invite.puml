@startuml

actor "Sinh viên" as SV
participant "View" as View
participant "Project\nController" as Controller
participant "Project\nService" as Service
participant "User\nService" as UserService
participant "Project\nRepository" as ProjectRepo
participant "Mail\nService" as MailService
participant "Role\nInit" as RoleInit
participant "Workspace\nUserProject\ntRepository" as WUPRepo

SV -> View : Access /manager/project/:id
View -> View : Check if student is in a project\n→ Show "Add student" button if not
SV -> View : Click "Add student" button
View -> View : Display form to add student(s)
SV -> View : Enter student ID(s) and submit
View -> Controller : POST /project/invite\n(ProjectInvitationRequest)

Controller -> Service : inviteUserToProject(request)

Service -> UserService : getCurrentUser()
UserService --> Service : return userInvite

Service -> ProjectRepo : findById(projectId)
ProjectRepo --> Service : return Project
alt not found
    Service -> Service : throw AppException(NOT_FOUND)
end

Service -> MailService : Khởi tạo MailRequest\n(template = "invite-student")

loop for each userId in request.userId
    Service -> UserService : getUserByUniId(userId)
    UserService --> Service : return User

    Service -> RoleInit : getRole("MEMBER")
    RoleInit --> Service : return Role

    Service -> WUPRepo : save(WorkspacesUsersProjects)
    Service -> MailService : inviteToProject(email, token, params)
end

Service --> Controller : return ApiResponse("Invite student to project")
Controller --> View : Hiển thị thông báo mời thành công

@enduml
